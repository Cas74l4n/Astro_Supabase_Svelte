---
import { supabase } from "../lib/supabase";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
    return redirect("/signin");
}

const { data, error } = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
});

if (error) {
    cookies.delete("sb-access-token", {
        path: "/",
    });
    cookies.delete("sb-refresh-token", {
        path: "/",
    });

    return redirect("/signin");
}

const email = data?.user?.email;

interface Props {
    title: string;
}

const { title } = Astro.props;
---

<!-- ya con el inicio de seccion -->
<html lang="en" class="h-full w-full">
    <head>
        <title>{title}</title>
        <meta charset="utf-8" />
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta name="viewport" content="width=device-width" />
    </head>
    <body
        class="flex flex-col h-full w-full dark:bg-zinc-900 bg-zinc-50 dark:text-zinc-100"
    >
        <nav class="border-b dark:bg-zinc-800 dark:border-zinc-700 z-10">
            <div
                class="flex items-center justify-end sm:justify-between p-4 max-w-screen-xl mx-auto"
            >
                <a href="/" class="sm:block font-semibold dark:text-white"
                    >Astro</a
                >
                <div>
                    <ul class="font-medium flex gap-8">
                        <li>
                            <div class="flex flex-row-reverse ">
                                <img
                                id="avatarButton"
                                class="w-9 h-9 rounded-full cursor-pointer"
                                src="https://flowbite.com/docs/images/people/profile-picture-5.jpg"
                                alt="User dropdown"
                            />
                            </div>

                            <!-- Dropdown menu -->
                            <div
                                id="userDropdown"
                                class="z-50 hidden bg-white divide-y divide-gray-100 rounded-lg shadow w-44 dark:bg-gray-700 dark:divide-gray-600"
                            >
                                <div
                                    class="px-4 py-3 text-sm text-gray-900 dark:text-white"
                                >
                                    <div>Bonnie Green</div>
                                    <div class="font-medium truncate">
                                        name@flowbite.com
                                    </div>
                                </div>
                                <ul
                                    class="py-2 text-sm text-gray-700 dark:text-gray-200"
                                    aria-labelledby="avatarButton"
                                >
                                    <li>
                                        <a
                                            href="#"
                                            class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                            >Dashboard
                                        </a>
                                    </li>
                                    <li>
                                        <a
                                            href="#"
                                            class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                            >Settings</a
                                        >
                                    </li>
                                    <li>
                                        <a
                                            href="#"
                                            class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                                            >Earnings</a
                                        >
                                    </li>
                                </ul>
                                <div class="py-1">
                                    <a
                                        href="/api/auth/signout"
                                        class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white"
                                        >Sign out</a
                                    >
                                </div>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <slot />
    </body>
</html>

<style is:global>
    html {
        font-family: system-ui, sans-serif;
        background: #13151a;
        background-size: 224px;
    }
    code {
        font-family:
            Menlo,
            Monaco,
            Lucida Console,
            Liberation Mono,
            DejaVu Sans Mono,
            Bitstream Vera Sans Mono,
            Courier New,
            monospace;
    }
    body {
        margin: auto;
        /* max-width: 1200px; */
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const avatarButton = document.getElementById("avatarButton");
        const userDropdown = document.getElementById("userDropdown");

        avatarButton.addEventListener("click", function () {
            userDropdown.classList.toggle("hidden");
        });
    });
</script>
